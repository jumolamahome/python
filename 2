from playwright.sync_api import sync_playwright
import os

def shot(page, name):
    os.makedirs("debug", exist_ok=True)
    page.screenshot(path=f"debug/{name}.png", full_page=True)

with sync_playwright() as p:
    browser = p.chromium.launch(headless=False, slow_mo=300)
    page = browser.new_page()
    page.set_default_timeout(15000)

    # =====================
    # é–‹å•Ÿ ezTravel
    # =====================
    page.goto("https://www.eztravel.com.tw/")
    page.wait_for_load_state("domcontentloaded")
    page.wait_for_timeout(2000)
    shot(page, "01_home")

    # =====================
    # ç›®çš„åœ°ï¼šæ´›æ‰ç£¯
    # =====================
    dest = page.locator("#search-flight-arrival-0")
    dest.click()
    dest.fill("")
    dest.type("æ´›æ‰ç£¯", delay=150)
    page.wait_for_timeout(1500)

    # é»ã€Œç¾æ´²ã€åˆ†é 
    page.locator("span.ez-tab-item", has_text="ç¾æ´²").click()

    # é¸ã€Œæ´›æ‰ç£¯ã€
    page.locator("ul li span", has_text="æ´›æ‰ç£¯").first.click()
    shot(page, "02_after_pick_destination")

    # =====================
    # é¸å»ç¨‹æ—¥æœŸ 2025/09/01
    # =====================
    depart_input = page.locator("#flight-search-date-range-0-select-start")
    depart_input.click()
    depart_input.fill("2025/09/01 (ä¸€)")
    shot(page, "03_depart_date")

    # =====================
    # é¸å›ç¨‹æ—¥æœŸ 2025/09/30
    # =====================
    return_input = page.locator("#flight-search-date-range-0-select-end")
    return_input.click()
    return_input.fill("2025/09/30 (äºŒ)")
    shot(page, "04_return_date")

    # =====================
    # é¸äººæ•¸ï¼ˆæ”¹æˆ 2 æˆäººï¼‰
    # =====================
    people_box = page.locator("#flight-search-people")
    people_box.click()
    page.wait_for_timeout(1000)

    # æˆäºº +1
    plus_adult = page.locator("div.Engine_room_people-modal_row___ZS3l", has_text="æˆäºº") \
                    .locator("svg.ez-icon.content-open").first
    plus_adult.click()
    page.wait_for_timeout(500)

    # æ”¶å›äººæ•¸é¸å–®
    page.locator("span.ez-search-engine-text-field_with-drop_select-text", has_text="2 æˆäººãƒ»0 å­©ç«¥ãƒ»0 å¬°å…’").click()
    shot(page, "05_member")

    # =====================
    # æŒ‰æœå°‹ä¸¦ç­‰å¾…çµæœè¼‰å…¥
    # =====================
    page.locator("button.ez-btn.search-lg").first.click()

    # ç­‰å¾…æœå°‹çµæœå€å¡Šå‡ºç¾ï¼ˆè«‹ç¢ºèª class/nameï¼‰
    search_container = page.locator("div.search-listing-container")  # ä¾å¯¦éš›æœå°‹çµæœå€å¡Šä¿®æ”¹
    search_container.wait_for(state="visible", timeout=15000)
    shot(page, "06_search_result")
    print("ğŸ”¹ æœå°‹çµæœé å·²è¼‰å…¥ï¼Œåœç•™åœ¨åŒä¸€é é¢")

    # æš«åœç¨‹å¼ï¼Œæ‰‹å‹•ç¢ºèª
    input("ğŸ”¹ æŒ‰ Enter éµçµæŸç¨‹å¼ä¸¦é—œé–‰ç€è¦½å™¨...")
    browser.close()
